SELECT 
PRD.NOM_MRC AS MARCA,
EXTRACT(YEAR FROM NF.DAT_EMS_NFS) AS ANO,
PRD.NOM_MOD AS MODELO,
CSS.NOM_GRP_CSS AS GRUPO_CSS,
CSS.NOM_REG AS REGIONAL_CSS,
CSS.NOM_EST AS ESTAD_CSS,
NF.DES_CND_VND AS COND_VENDA,
COUNT(NF.COD_VIN) as TOTAL

/*
NF.DAT_EMS_NFS, NF.DES_CND_VND, NF.DES_CND_VND_DTL, NF.NOM_BCO,NF.NUM_CPF_VEN,NF.NOM_VEN,NF.COD_TIP_CHS,NF.COD_VIN,NF.COD_SIS_NFE,NF.NUM_NFS,NF.NUM_SER_NFS,NF.VLR_NFS,

CSS.COD_IND_TIP_CSS,CSS.DES_IND_TIP_CSS,CSS.COD_CSS,CSS.NOM_CSS,CSS.NOM_GRP_CSS,CSS.NOM_MNC as NOM_MNC_CSS,CSS.COD_EST as COD_EST_CSS,CSS.NOM_EST as NOM_EST_CSS,CSS.NUM_CEP as NUM_CEP_CSS,CSS.DES_REG_VND,CSS.NOM_REG_ABV,CSS.COD_REG,CSS.NOM_REG,

CLI.COD_TIP_PES,CLI.DES_TIP_PES,CLI.DES_EML_CLI,CLI.NUM_TLF as NUM_TLF_CLI,CLI.DAT_NAS,CLI.DES_ECV,

VEI.DAT_EPL,VEI.NUM_ANO_FBR,VEI.NUM_ANO_MOD,VEI.DAT_ENT_VEI,VEI.DAT_ENT_CLI_FIM,

CLI_NFE.NUM_CPF_CGC,CLI_NFE.NOM_CLI,CLI_NFE.DES_END,CLI_NFE.NUM_END,CLI_NFE.DES_CPL_END,CLI_NFE.NUM_CEP NUM_CEP_CLI_NFE,CLI_NFE.NOM_BAI,CLI_NFE.NOM_MNC as NOM_MNC_CLI_NFE,CLI_NFE.COD_EST as COD_EST_CLI_NFE,CLI_NFE.NOM_EST as NOM_EST_CLI_NFE,CLI_NFE.NUM_TLF as NUM_TLF_CLI_NFE,CLI_NFE.DES_EML,

PRD.COD_MOD,PRD.NOM_MOD,PRD.COD_VRS,PRD.NOM_VRS,PRD.NUM_SER,PRD.COD_PRD,PRD.DES_ORI,PRD.VLR_PTN_CVS,PRD.VLR_CIL,PRD.DES_FXA_CIL,PRD.COD_CMB,
PRD.DES_CMB,PRD.NOM_MRC
*/

FROM `data-lake-brain.NotaFiscal.Veiculos` as NF
INNER JOIN `data-lake-brain.Brain.Concessionaria` as CSS ON CSS.COD_CSS = NF.COD_CSS

INNER JOIN (
  SELECT COD_CLI, MAX_DAT_REF, MAX(SRK_CLI) AS MAX_SRK_CLI FROM (
    SELECT COD_CLI, SRK_CLI, MAX(DAT_REF) AS MAX_DAT_REF FROM `data-lake-brain.Cliente.Cliente` WHERE NOM_SIS_ORI = 'CARE' GROUP BY COD_CLI, SRK_CLI
  ) GROUP BY COD_CLI, MAX_DAT_REF
) MAX_CLI ON MAX_CLI.COD_CLI = NF.COD_CLI
INNER JOIN `data-lake-brain.Cliente.Cliente` as CLI ON CLI.COD_CLI = MAX_CLI.COD_CLI AND CLI.SRK_CLI = MAX_CLI.MAX_SRK_CLI AND CLI.DAT_REF = MAX_CLI.MAX_DAT_REF AND CLI.NOM_SIS_ORI = 'CARE' 

INNER JOIN (SELECT COD_VIN, MAX(DAT_REF) AS MAX_DAT_REF FROM `data-lake-brain.Veiculo.Veiculo` GROUP BY COD_VIN) MAX_VIN ON MAX_VIN.COD_VIN = NF.COD_VIN
INNER JOIN `data-lake-brain.Veiculo.Veiculo` as VEI ON VEI.COD_VIN = MAX_VIN.COD_VIN AND VEI.DAT_REF = MAX_VIN.MAX_DAT_REF

INNER JOIN `data-lake-brain.Veiculo.Produto` as PRD ON PRD.COD_PRD = VEI.COD_PRD
INNER JOIN `data-lake-brain.Cliente.ClienteNFe` as CLI_NFE ON CLI_NFE.SRK_CLI_NFE = NF.SRK_CLI_NFE

WHERE 
PRD.NOM_MRC = 'JEEP' AND
BYTE_LENGTH(CLI_NFE.NUM_CPF_CGC) = 11 AND
EXTRACT(YEAR FROM NF.DAT_EMS_NFS) > 2014

GROUP BY 
PRD.NOM_MRC,EXTRACT(YEAR FROM NF.DAT_EMS_NFS),PRD.NOM_MOD, CSS.NOM_REG, NF.DES_CND_VND,CSS.NOM_EST,CSS.NOM_GRP_CSS

--VEI.COD_TIP_CHS IN ('611K249532')

